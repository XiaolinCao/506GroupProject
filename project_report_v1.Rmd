---
title: "506 Group Project: Diabetes"
date: November 30, 2019
output: html_document
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

<p> 
  According to the survey from American Diabetes Association, more than 30 million      Americans have diabetes and around 84 million Americans have pre-diabetes. The health care costs of diagnosed diabetes are 327 billion per year according to the 2017 statistics. Compared with those without diabetes, people with diabetes are spending 2.3 times more on their medical expenditure. With National Health and Nutrition Examination Survey on hand, our group are interested in exploring the prevalence of diabetes in terms of demographic features, dietary habits and alcohol use. 
</p>

<p> 
  In the end of our analysis, we will show how gender, age, nutrient, occupation, alcohol use and sleep quality are associated with the probability of being diagnosed with diabetes. By comparing respective odds ratios, we will come to a conclusion that describes which population are more subject to diabetes. 
</p>

# Data
* reponse variable: DIQ010 (<em>Doctor told you have diabetes</em>), Dataset: DIQ_I.XPT (<em>Diabetes 2015 - 2016</em>)
* predicting variables:
    + RIAGENDER (<em>Gender</em>), Dataset: DEMO_I.XPT (<em>Demographic Variables and Sample Weights 2015 - 2016</em>)
    + RIDAGEYR (<em>Age in years at screening</em>), Dataset: DEMO_I.XPT (<em>Demographic Variables and Sample Weights 2015 - 2016</em>)
    + ALQ130 (<em>Avg # alcoholic drinks/day past 12 mons</em>), Dataset: ALQ_I.XPT (<em>Alcohol Use 2015 - 2016</em>)
    + DR1ISUGR (<em>Total sugars (gm)</em>), Dataset: DR1IFF_I.XPT  (<em>Dietary Interview Individual Foods, First Day 2015 - 2016</em>)
    + DR1ITFAT (<em>Total fat (gm)</em>), Dataset: DR1IFF_I.XPT  (<em>Dietary Interview Individual Foods, First Day 2015 - 2016</em>)
    + DR1TSUGR (<em>Total sugars (gm)</em>), Dataset: DR1TOT_I.XPT (<em>Dietary Interview Total Nutrients Intakes, First Day 2015 - 2016</em>)
    + DR1TTFAT (<em>Total fat (gm)</em>), Dataset: DR1TOT_I.XPT (<em>Dietary Interview Total Nutrients Intakes, First Day 2015 - 2016</em>)
    + OCQ260 (<em>Description of job/work situation</em>), Dataset: OCQ_I.XPT (<em>Occupation 2015 - 2016</em>)
    + SLD012 (<em>Sleep hours</em>), Dataset: SLQ_I.XPT (<em>Sleep Disorders 2015 - 2016</em>)

# Methods
<p>
  We preprocessed and cleaned all the variables beforehand. The rows with missing values are removed and some variables are recoded for consistency. After the data preprocessing step, we fit the dataset with logistic regression. We carried out the above procedures in R, python and STATA. 
</p>

<p>
  We have set some common rules for performing the data cleaning part. The response variable DIQ010 should be coded as 1: <em>Yes</em> and 0: <em>No</em> and should be treated as a categorical variable. RIAGENDER (<em>Gender</em>) should be coded as 1: <em>Males</em> and 2: <em>Female</em> and should be treated as categorical variable. ALQ130 (<em>Avg # alcoholic drinks/day past 12 mons</em>) should range from 1 to 15. The use of two datasets DR1IFF_I.XPT and DR1TOT_I.XPT is to confirm the measurement accuracy of total sugar intake and total fat intake. OCQ260 (<em>Description of job/work situation</em>) should be recoded as 1: <em>private business employee</em>, 2: <em>government employee</em> and 3: <em>self-employed</em> and should be treated as a categorical variable.
</p>

# Core Analysis {.tabset}

## R
```{r, eval=FALSE}
library(haven)
# read in all the datasets
files = c("ALQ_I.XPT", "DEMO_I.XPT", "DIQ_I.XPT", 
          "DR1IFF_I.XPT", "OCQ_I.XPT", "SLQ_I.XPT", "DR1TOT_I.XPT")
das = list()
for (f in files) {
    dx = read_xpt(f)
    das[[length(das)+1]] = dx
}

# store data
alcohol = das[[1]]
demo = das[[2]]
diabete = das[[3]]
dietary = das[[4]]
occupation = das[[5]]
sleep = das[[6]]
total_nutrient = das[[7]]

# clean variables 
library(tidyverse)
alcohol = alcohol %>% 
  select(SEQN, ALQ130)
demo = demo %>%
  select(SEQN, RIAGENDR, RIDAGEYR)
occupation = occupation %>%
  select(SEQN, OCQ260)
diabete = diabete %>%
  transmute(SEQN, 
            DIQ010 = ifelse(DIQ010 == 2, 0, DIQ010))

# check if sums of one-day sugar and fat are equal to those of total nutrients dataset
dietary = dietary %>%
  select(SEQN, DR1ISUGR, DR1ITFAT) %>%
  group_by(SEQN) %>%
  summarize(Tot_sugar = sum(DR1ISUGR),
            Tot_fat = sum(DR1ITFAT))

total_nutrient = total_nutrient %>%
  select(SEQN,DR1TSUGR, DR1TTFAT)

total_nutrient
dietary


sleep = sleep %>%
  select(SEQN, SLD012)

# join all the datasets
df = left_join(sleep, 
               left_join(occupation, 
                         left_join(dietary, 
                                   left_join(diabete, 
                                             left_join(alcohol, demo, 
                                                       by = "SEQN"), 
                                             by = "SEQN"), 
                                   by = "SEQN"), 
                         by = "SEQN"), 
               by = "SEQN")

# delete missing values
missing = nrow(df) - nrow(df %>% drop_na())
cat("missing = ", missing) # one third of the data is missing
df = df %>%
  select(-SEQN) %>%
  drop_na() %>%
  filter(DIQ010 %in% c(0,1)) %>%
  filter( !(ALQ130 %in% c(777, 999)) ) %>%
  # only keep three occupation types
  # change 'gender', 'occupation', and 'diabete' to factor
  filter( !(OCQ260 %in% c(77,99,6)) ) %>%
  mutate( OCQ260 = ifelse(OCQ260 %in% c(2,3,4), 2, OCQ260),
          OCQ260 = ifelse(OCQ260 == 5, 3, OCQ260),
          OCQ260 = as.factor(OCQ260), 
          DIQ010 = as.factor(DIQ010), 
          RIAGENDR = as.factor(RIAGENDR))
summary(df)

# two-way contingency table
xtabs(~DIQ010 + OCQ260, data = df)
xtabs(~DIQ010 + RIAGENDR , data = df)
# seems like occupation 1 has lower diabete percentage than 2 and 3

# fit the model with logistic regression
fit = glm(DIQ010 ~ ., data = df, family = "binomial")
summary(fit)
```
## Python

## STATA
```{r, eval = FALSE}
* Import and merge ------------------------------------------------------------
pwd
cd C:\Users\xiaolc\Downloads
pwd

// response variables
// diabetes
fdause DIQ_I.XPT, clear
quietly compress
gsort +seqn
keep seqn diq010
save DIABETES.dta, replace

// predicting variables
// gender, age
fdause DEMO_I.XPT, clear
quietly compress
gsort +seqn
keep seqn riagendr ridageyr
merge 1:1 seqn using DIABETES.dta

keep if _merge == 3
save DIA_DEMO.dta, replace

// alcohol
fdause ALQ_I.XPT, clear
quietly compress
gsort +seqn
keep seqn alq130
merge 1:1 seqn using DIA_DEMO.dta, generate(merge2)

keep if merge2 == 3
save DIA_DEMO_ALC.dta, replace

// total sugars, total fat
fdause DR1TOT_I.XPT
quietly compress
gsort +seqn
keep seqn dr1tsugr dr1ttfat
merge 1:1 seqn using DIA_DEMO_ALC.dta, generate(merge3)

keep if merge3 == 3
save DIA_DEMO_ALC_NUTR.dta, replace

// occupation
fdause OCQ_I.XPT, clear
quietly compress
gsort +seqn
keep seqn ocq260
merge 1:1 seqn using DIA_DEMO_ALC_NUTR.dta, generate(merge4)

keep if merge4 == 3
save DIA_DEMO_ALC_NUTR_OCU.dta, replace

// sleep disorder
fdause SLQ_I.XPT
quietly compress
gsort +seqn
keep seqn sld012
merge 1:1 seqn using DIA_DEMO_ALC_NUTR_OCU.dta, generate(merge5)

keep if merge5 == 3
save dataset.dta, replace

rename sld012 sleep
rename ocq260 occupation
rename dr1tsugr tot_sugr
rename dr1ttfat tot_fat
rename alq130 alcohol
rename riagendr gender
rename ridageyr age
rename diq010 diabete

// recode diabete: 0: no diabete, 1: has diabete
replace diabete = 0 if diabete == 2

// recode occupation: 1: private business employee
//					  2: government employee
//					  3: self-employed
replace occupation = 2 if (occupation == 2 | occupation == 3 | occupation == 4)
replace occupation = 3 if occupation == 5

// remove missing values and unqualified values
generate missing = 0
replace missing = 1 if (seqn == . | diabete == 3 | diabete == 7 | diabete == 9 | diabete == . | age == . | gender == . | alcohol == 777 | alcohol == 999 | alcohol == . | tot_fat == . | tot_sugr == . | occupation == 6 | occupation == 77 | occupation == 99 | occupation == . | sleep == .)
drop if missing == 1

// fit the logistic model
logit diabete age i.gender alcohol tot_fat tot_sugr i.occupation sleep, or
matrix model = r(table)

mata
model = st_matrix("model")
model = round(model[(1, 2, 5, 6), (1, 3, 4, 5, 6, 8, 9, 10)], 0.001)
model = model'
st_matrix("final_model", model)
end

putexcel set 506project_res.csv, replace
putexcel A2 = "age"
putexcel A3 = "2.gender"
putexcel A4 = "alcohol"
putexcel A5 = "tot_fat"
putexcel A6 = "tot_sugr"
putexcel A7 = "2.occupation"
putexcel A8 = "3.occupation"
putexcel A9 = "sleep"
putexcel B1 = "est"
putexcel C1 = "se"
putexcel D1 = "lwr"
putexcel E1 = "upr"
putexcel B2 = matrix(final_model)

putexcel save
```

```{r, eval=FALSE}
res = read.csv("506project_res.csv", fileEncoding = "UTF-16LE")
knitr::kable(res, caption="Odds Ratios")
```